# AutoGenç³»çµ±æ¸¬è©¦ Makefile
# Copyright (c) 2025 Bytedance Ltd. and/or its affiliates
# SPDX-License-Identifier: MIT

.PHONY: help test test-unit test-integration test-performance test-all clean coverage lint format install-deps

# Default target
help:
	@echo "AutoGen System Test Commands:"
	@echo ""
	@echo "  make test-unit          - Run unit tests"
	@echo "  make test-integration   - Run integration tests"
	@echo "  make test-performance   - Run performance tests"
	@echo "  make test-all          - Run all tests"
	@echo "  make test              - Run all tests (default)"
	@echo "  make coverage          - Run tests with coverage report"
	@echo "  make lint              - Run code linting"
	@echo "  make format            - Format code"
	@echo "  make clean             - Clean test files"
	@echo "  make install-deps      - Install test dependencies"
	@echo ""

# è®Šæ•¸å®šç¾©
PYTHON := python
TEST_DIR := tests/autogen_system
REPORT_DIR := test_reports
SOURCE_DIR := src/autogen_system

# å®‰è£æ¸¬è©¦ä¾è³´
install-deps:
	@echo "Installing test dependencies..."
	$(PYTHON) -m pip install pytest pytest-asyncio pytest-mock pytest-cov coverage psutil

# å–®å…ƒæ¸¬è©¦
test-unit:
	@echo "Running AutoGen unit tests..."
	$(PYTHON) -m pytest $(TEST_DIR)/unit -v --tb=short --durations=10

# é›†æˆæ¸¬è©¦
test-integration:
	@echo "Running AutoGen integration tests..."
	$(PYTHON) -m pytest $(TEST_DIR)/integration -v --tb=short --durations=10 -m "not performance and not benchmark"

# æ€§èƒ½æ¸¬è©¦
test-performance:
	@echo "Running AutoGen performance tests..."
	$(PYTHON) -m pytest $(TEST_DIR)/integration/test_performance.py -v --tb=short -m "performance or benchmark"

# æ‰€æœ‰æ¸¬è©¦
test-all: test-unit test-integration test-performance

# é»˜èªæ¸¬è©¦ï¼ˆä¸åŒ…å«æ€§èƒ½æ¸¬è©¦ï¼‰
test:
	@echo "Running AutoGen test suite..."
	$(PYTHON) -m pytest $(TEST_DIR) -v --tb=short --durations=10 -m "not performance and not benchmark"

# æ¸¬è©¦é‹è¡Œå™¨
test-runner:
	@echo "ğŸš€ ä½¿ç”¨æ¸¬è©¦é‹è¡Œå™¨..."
	$(PYTHON) $(TEST_DIR)/test_runner.py --suite all --verbose

test-runner-unit:
	@echo "ğŸ§ª ä½¿ç”¨æ¸¬è©¦é‹è¡Œå™¨ - å–®å…ƒæ¸¬è©¦..."
	$(PYTHON) $(TEST_DIR)/test_runner.py --suite unit --verbose

test-runner-integration:
	@echo "ğŸ”— ä½¿ç”¨æ¸¬è©¦é‹è¡Œå™¨ - é›†æˆæ¸¬è©¦..."
	$(PYTHON) $(TEST_DIR)/test_runner.py --suite integration --verbose

test-runner-performance:
	@echo "ğŸš€ ä½¿ç”¨æ¸¬è©¦é‹è¡Œå™¨ - æ€§èƒ½æ¸¬è©¦..."
	$(PYTHON) $(TEST_DIR)/test_runner.py --suite performance --verbose

# è¦†è“‹ç‡æ¸¬è©¦
coverage:
	@echo "Running coverage tests..."
	$(PYTHON) -m pytest $(TEST_DIR) --cov=$(SOURCE_DIR) --cov-report=html --cov-report=term --cov-report=xml -m "not performance and not benchmark"
	@echo "Coverage report generated in htmlcov/ directory"

# å¿«é€Ÿæ¸¬è©¦ï¼ˆç°¡åŒ–è¼¸å‡ºï¼‰
test-quick:
	@echo "âš¡ å¿«é€Ÿæ¸¬è©¦..."
	$(PYTHON) -m pytest $(TEST_DIR) -q --tb=line -x -m "not performance and not benchmark"

# æ¸¬è©¦ç‰¹å®šæ–‡ä»¶
test-file:
	@echo "ğŸ“„ æ¸¬è©¦æŒ‡å®šæ–‡ä»¶: $(FILE)"
	$(PYTHON) -m pytest $(FILE) -v --tb=short

# æ¸¬è©¦ç‰¹å®šæ¨¡å¼
test-pattern:
	@echo "ğŸ” æ¸¬è©¦åŒ¹é…æ¨¡å¼: $(PATTERN)"
	$(PYTHON) -m pytest $(TEST_DIR) -k "$(PATTERN)" -v --tb=short

# ä¸¦è¡Œæ¸¬è©¦
test-parallel:
	@echo "ğŸ”„ ä¸¦è¡Œé‹è¡Œæ¸¬è©¦..."
	$(PYTHON) -m pytest $(TEST_DIR) -n auto --tb=short -m "not performance and not benchmark"

# ä»£ç¢¼æª¢æŸ¥
lint:
	@echo "ğŸ” é‹è¡Œä»£ç¢¼æª¢æŸ¥..."
	@echo "æª¢æŸ¥ src/autogen_system/..."
	$(PYTHON) -m flake8 $(SOURCE_DIR) --max-line-length=100 --extend-ignore=E203,W503
	@echo "æª¢æŸ¥æ¸¬è©¦æ–‡ä»¶..."
	$(PYTHON) -m flake8 $(TEST_DIR) --max-line-length=100 --extend-ignore=E203,W503

# ä»£ç¢¼æ ¼å¼åŒ–
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç¢¼..."
	$(PYTHON) -m black $(SOURCE_DIR) $(TEST_DIR) --line-length=100
	$(PYTHON) -m isort $(SOURCE_DIR) $(TEST_DIR) --profile black

# é¡å‹æª¢æŸ¥
typecheck:
	@echo "ğŸ” é‹è¡Œé¡å‹æª¢æŸ¥..."
	$(PYTHON) -m mypy $(SOURCE_DIR) --ignore-missing-imports

# æ¸…ç†æ¸¬è©¦æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ¸¬è©¦æ–‡ä»¶..."
	rm -rf $(REPORT_DIR)
	rm -rf .pytest_cache
	rm -rf htmlcov
	rm -rf .coverage
	rm -rf coverage.xml
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name ".coverage.*" -delete

# å‰µå»ºæ¸¬è©¦å ±å‘Šç›®éŒ„
setup-reports:
	@echo "ğŸ“ å‰µå»ºå ±å‘Šç›®éŒ„..."
	mkdir -p $(REPORT_DIR)

# å®Œæ•´çš„æ¸¬è©¦æµç¨‹
test-full: clean install-deps lint test coverage
	@echo "âœ… å®Œæ•´æ¸¬è©¦æµç¨‹å®Œæˆ"

# æŒçºŒé›†æˆæ¸¬è©¦
test-ci:
	@echo "ğŸ—ï¸ æŒçºŒé›†æˆæ¸¬è©¦..."
	$(PYTHON) -m pytest $(TEST_DIR) --tb=short --junit-xml=$(REPORT_DIR)/junit.xml --cov=$(SOURCE_DIR) --cov-report=xml -m "not performance and not benchmark"

# èª¿è©¦æ¨¡å¼æ¸¬è©¦
test-debug:
	@echo "ğŸ› èª¿è©¦æ¨¡å¼æ¸¬è©¦..."
	$(PYTHON) -m pytest $(TEST_DIR) -v --tb=long --capture=no -s

# æ¸¬è©¦çµ±è¨ˆ
test-stats:
	@echo "ğŸ“ˆ æ¸¬è©¦çµ±è¨ˆ..."
	@echo "å–®å…ƒæ¸¬è©¦æ–‡ä»¶æ•¸ï¼š"
	@find $(TEST_DIR)/unit -name "test_*.py" | wc -l
	@echo "é›†æˆæ¸¬è©¦æ–‡ä»¶æ•¸ï¼š"
	@find $(TEST_DIR)/integration -name "test_*.py" | wc -l
	@echo "ç¸½æ¸¬è©¦æ–‡ä»¶æ•¸ï¼š"
	@find $(TEST_DIR) -name "test_*.py" | wc -l

# ç›£è¦–æ–‡ä»¶è®ŠåŒ–ä¸¦è‡ªå‹•æ¸¬è©¦
test-watch:
	@echo "ğŸ‘€ ç›£è¦–æ–‡ä»¶è®ŠåŒ–..."
	$(PYTHON) -m ptw $(SOURCE_DIR) $(TEST_DIR) -- -v --tb=short -m "not performance and not benchmark"

# æ€§èƒ½åŸºæº–æ¸¬è©¦
benchmark:
	@echo "ğŸ“Š é‹è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦..."
	$(PYTHON) -m pytest $(TEST_DIR)/integration/test_performance.py::TestPerformanceBenchmarks -v --tb=short

# å…§å­˜æ³„æ¼æª¢æ¸¬
test-memory:
	@echo "ğŸ” å…§å­˜æ³„æ¼æª¢æ¸¬..."
	$(PYTHON) -m pytest $(TEST_DIR)/integration/test_performance.py::TestPerformanceMetrics::test_memory_efficiency -v -s

# è² è¼‰æ¸¬è©¦
test-load:
	@echo "âš¡ è² è¼‰æ¸¬è©¦..."
	$(PYTHON) -m pytest $(TEST_DIR)/integration/test_performance.py::TestPerformanceMetrics::test_load_testing -v -s

# é¡¯ç¤ºæ¸¬è©¦å¹«åŠ©
test-help:
	@echo "ğŸ“š æ¸¬è©¦å‘½ä»¤å¹«åŠ©ï¼š"
	@echo ""
	@echo "åŸºæœ¬æ¸¬è©¦ï¼š"
	@echo "  make test              - é‹è¡ŒåŸºæœ¬æ¸¬è©¦å¥—ä»¶"
	@echo "  make test-quick        - å¿«é€Ÿæ¸¬è©¦ï¼ˆå¤±æ•—æ™‚åœæ­¢ï¼‰"
	@echo "  make test-debug        - èª¿è©¦æ¨¡å¼æ¸¬è©¦"
	@echo ""
	@echo "ç‰¹å®šæ¸¬è©¦ï¼š"
	@echo "  make test-file FILE=path/to/test.py"
	@echo "  make test-pattern PATTERN='test_name'"
	@echo ""
	@echo "æ€§èƒ½æ¸¬è©¦ï¼š"
	@echo "  make benchmark         - åŸºæº–æ¸¬è©¦"
	@echo "  make test-memory       - å…§å­˜æ¸¬è©¦"
	@echo "  make test-load         - è² è¼‰æ¸¬è©¦"
	@echo ""
	@echo "å·¥å…·ï¼š"
	@echo "  make coverage          - è¦†è“‹ç‡å ±å‘Š"
	@echo "  make lint             - ä»£ç¢¼æª¢æŸ¥"
	@echo "  make format           - ä»£ç¢¼æ ¼å¼åŒ–"
	@echo ""

# é æäº¤æª¢æŸ¥
pre-commit: lint typecheck test-quick
	@echo "âœ… é æäº¤æª¢æŸ¥å®Œæˆ"

# ç™¼å¸ƒå‰æª¢æŸ¥
pre-release: clean install-deps lint typecheck test-full
	@echo "âœ… ç™¼å¸ƒå‰æª¢æŸ¥å®Œæˆ"
